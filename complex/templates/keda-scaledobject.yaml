{{- range $componentName, $component := .Values.components }}
{{- if and (eq $component.type "consumer") (hasKey $component "keda") }}
{{- $keda := $component.keda }}
{{- $name := include "component.name" (dict "name" $componentName "Release" $.Release) }}

---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $name }}-scaler
spec:
  scaleTargetRef:
    name: {{ $name }}
  minReplicaCount: {{ $keda.minReplicaCount | default 0 }}
  maxReplicaCount: {{ $keda.maxReplicaCount | default 2 }}
  pollingInterval: {{ $keda.pollingInterval | default 15 }}
  cooldownPeriod: {{ $keda.cooldownPeriod | default 30 }}
  triggers:
  {{- range $i, $trigger := $keda.triggers }}
    {{- if eq $trigger.type "kafka" }}
      {{- $awsRegion := $trigger.awsRegion | default $.Values.global.keda.awsRegion }}
      {{- if (not $awsRegion) }}
        {{- fail (printf "Kafka trigger for '%s' is missing required field(s)." $componentName) }}
      {{- end }}
    - type: kafka
      metadata:
        activationLagThreshold: {{ $trigger.activationLagThreshold | default "0" | quote }}
        bootstrapServers: {{ $trigger.bootstrapServers | quote }}
        consumerGroup: {{ $trigger.consumerGroup | quote }}
        offsetResetPolicy: {{ $trigger.offsetResetPolicy | default "earliest" }}
        {{- if $trigger.topic }}
        topic: {{ $trigger.topic | quote }}
        {{- end }}
        identityOwner: {{ $trigger.identityOwner | default "operator" | quote }}
        tls: "enable"
        lagThreshold: {{ $trigger.lagThreshold | quote }}
        {{- if eq ($trigger.identityOwner | default "operator") "operator" }}
        awsRegion: {{ $awsRegion | quote }}
        sasl: oauthbearer
        saslTokenProvider: aws_msk_iam
        {{- end }}

    {{- else if eq $trigger.type "aws-sqs-queue" }}
      {{- $awsRegion := $trigger.awsRegion | default $.Values.global.keda.awsRegion }}
      {{- if (not $awsRegion) }}
        {{- fail (printf "SQS trigger for '%s' is missing required field(s)." $componentName) }}
      {{- end }}
    - type: aws-sqs-queue
      {{ if not (eq ($trigger.identityOwner | default "operator") "operator") -}}
      authenticationRef:
        name: {{ $componentName }}-auth-{{ $i }}
      {{ end -}}
      metadata:
        activationQueueLength: {{ $trigger.activationQueueLength | default "0" | quote }}
        awsRegion: {{ $awsRegion | quote }}
        identityOwner: {{ $trigger.identityOwner | default "operator" | quote }}
        queueLength: {{ $trigger.queueLength | quote }}
        queueURLFromEnv: {{ $trigger.queueURLFromEnv | quote }}

    {{- else if eq $trigger.type "cron" }}
    - type: cron
      metadata:
        desiredReplicas: {{ $trigger.desiredReplicas | quote }}
        timezone: {{ $trigger.timezone | quote }}
        start: {{ $trigger.start | quote }}
        end: {{ $trigger.end | quote }}

    {{- else if eq $trigger.type "prometheus" }}
      {{- if not $trigger.serverAddress }}
        {{- fail (printf "Prometheus trigger for '%s' is missing required field 'serverAddress'." $componentName) }}
      {{- end }}
      {{- if and (not $trigger.metricName) (not $trigger.query) }}
        {{- fail (printf "Prometheus trigger for '%s' must have either 'metricName' or 'query'." $componentName) }}
      {{- end }}
      {{- if not $trigger.threshold }}
        {{- fail (printf "Prometheus trigger for '%s' is missing required field 'threshold'." $componentName) }}
      {{- end }}
    - type: prometheus
      metadata:
        serverAddress: {{ $trigger.serverAddress | quote }}
        threshold: {{ $trigger.threshold }}
        {{- if $trigger.metricName }}
        metricName: {{ $trigger.metricName | quote }}
        {{- end }}
        {{- if $trigger.query }}
        query: {{ $trigger.query | quote }}
        {{- end }}
        {{- if $trigger.activationThreshold }}
        activationThreshold: {{ $trigger.activationThreshold }}
        {{- end }}
        {{- if $trigger.ignoreNullValues }}
        ignoreNullValues: {{ $trigger.ignoreNullValues | quote }}
        {{- end }}
        {{- if $trigger.unsafeSsl }}
        unsafeSsl: {{ $trigger.unsafeSsl | quote }}
        {{- end }}
        {{- if $trigger.customHeaders }}
        customHeaders: {{ $trigger.customHeaders | quote }}
        {{- end }}
        {{- if $trigger.namespace }}
        namespace: {{ $trigger.namespace | quote }}
        {{- end }}
        {{- if $trigger.queryParameters }}
        queryParameters: {{ $trigger.queryParameters | quote }}
        {{- end }}

    {{- else }}
      {{- fail (printf "Unknown trigger type '%s' in component '%s'" $trigger.type $componentName) }}
    {{- end }}
  {{- end }}

{{- end }}
{{- end }}
